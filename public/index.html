<!DOCTYPE html>
<html lang="tr">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>WebRTC SinyalleÅŸme Test</title>
    <!-- Font Awesome Ä°konlarÄ± -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.15.4/css/all.min.css">
    <style>
        body {
            font-family: Arial, sans-serif;
            max-width: 800px;
            margin: 0 auto;
            padding: 20px;
        }

        .container {
            display: flex;
            flex-direction: column;
            gap: 20px;
        }

        .row {
            display: flex;
            gap: 20px;
        }

        .video-container {
            display: flex;
            flex-wrap: wrap;
            gap: 20px;
        }

        video {
            width: 320px;
            height: 240px;
            background-color: black;
            border-radius: 8px;
        }

        button {
            padding: 10px 15px;
            background-color: #4CAF50;
            color: white;
            border: none;
            border-radius: 4px;
            cursor: pointer;
        }

        button:hover {
            background-color: #45a049;
        }

        button:disabled {
            background-color: #cccccc;
            cursor: not-allowed;
        }

        input,
        select {
            padding: 8px;
            border: 1px solid #ddd;
            border-radius: 4px;
        }

        #logContainer {
            margin-top: 20px;
            height: 200px;
            overflow-y: auto;
            border: 1px solid #ddd;
            padding: 10px;
            background-color: #f9f9f9;
            border-radius: 4px;
        }

        .log-entry {
            margin-bottom: 5px;
            border-bottom: 1px solid #eee;
            padding-bottom: 5px;
        }

        .error {
            color: red;
        }

        .success {
            color: green;
        }

        /* Medya Kontrolleri Stilleri */
        .media-controls {
            display: flex;
            justify-content: center;
            gap: 10px;
            margin-top: 10px;
        }

        .media-controls button {
            padding: 8px 12px;
            background-color: #4CAF50;
            color: white;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            transition: background-color 0.3s;
        }

        .media-controls button:hover {
            background-color: #45a049;
        }

        .media-controls button:disabled {
            background-color: #cccccc;
            cursor: not-allowed;
        }

        /* Font Awesome ikonlarÄ± iÃ§in stil */
        .fas {
            margin-right: 5px;
        }

        /* Chat Stilleri */
        .chat-container {
            border: 1px solid #ddd;
            border-radius: 8px;
            overflow: hidden;
            margin-top: 20px;
        }

        .chat-container h3 {
            margin: 0;
            padding: 10px;
            background-color: #f0f0f0;
            border-bottom: 1px solid #ddd;
        }

        .chat-messages {
            height: 250px;
            overflow-y: auto;
            padding: 10px;
            background-color: #fff;
        }

        .chat-input-area {
            display: flex;
            border-top: 1px solid #ddd;
            padding: 10px;
            background-color: #f9f9f9;
        }

        .chat-input-area input {
            flex: 1;
            margin-right: 10px;
        }

        .chat-message {
            margin-bottom: 10px;
            padding: 8px 12px;
            border-radius: 18px;
            display: inline-block;
            max-width: 80%;
            word-wrap: break-word;
            position: relative;
        }

        .chat-message.own {
            background-color: #dcf8c6;
            margin-left: auto;
            text-align: right;
            float: right;
            clear: both;
        }

        .chat-message.other {
            background-color: #f1f1f1;
            margin-right: auto;
            float: left;
            clear: both;
        }

        .message-sender {
            font-weight: bold;
            font-size: 0.8em;
            margin-bottom: 3px;
        }

        .message-time {
            font-size: 0.7em;
            color: #777;
            margin-top: 2px;
            text-align: right;
        }

        .message-content {
            line-height: 1.4;
        }

        /* Temizleme */
        .clearfix::after {
            content: "";
            clear: both;
            display: table;
        }

        /* KullanÄ±cÄ± GiriÅŸ Modal */
        .modal-overlay {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background-color: rgba(0, 0, 0, 0.7);
            display: flex;
            align-items: center;
            justify-content: center;
            z-index: 1000;
        }

        .modal-container {
            background-color: white;
            padding: 30px;
            border-radius: 8px;
            width: 350px;
            max-width: 90%;
            box-shadow: 0 4px 15px rgba(0, 0, 0, 0.2);
        }

        .modal-title {
            font-size: 1.5em;
            margin-bottom: 20px;
            text-align: center;
        }

        .form-group {
            margin-bottom: 15px;
        }

        .form-group label {
            display: block;
            margin-bottom: 5px;
            font-weight: bold;
        }

        .form-control {
            width: 100%;
            padding: 10px;
            border: 1px solid #ddd;
            border-radius: 4px;
            font-size: 16px;
        }

        .color-picker {
            display: flex;
            justify-content: space-between;
            margin-top: 8px;
        }

        .color-option {
            width: 30px;
            height: 30px;
            border-radius: 50%;
            cursor: pointer;
            transition: transform 0.2s;
        }

        .color-option:hover {
            transform: scale(1.1);
        }

        .color-option.selected {
            border: 3px solid #333;
        }

        .btn-primary {
            background-color: #4CAF50;
            width: 100%;
            margin-top: 10px;
            padding: 12px;
            font-size: 16px;
            font-weight: bold;
        }

        .hidden {
            display: none !important;
        }

        /* Avatar Stili */
        .avatar {
            width: 40px;
            height: 40px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 16px;
            font-weight: bold;
            color: white;
            margin-right: 10px;
        }

        .participant {
            display: flex;
            align-items: center;
            margin-bottom: 8px;
            padding: 5px;
            border-radius: 4px;
        }

        .participant.active {
            background-color: #f0f0f0;
        }
    </style>
</head>

<body>
    <!-- KullanÄ±cÄ± GiriÅŸ ModalÄ± -->
    <div id="userLoginModal" class="modal-overlay">
        <div class="modal-container">
            <div class="modal-title">GÃ¶rÃ¼ÅŸmeye KatÄ±lÄ±n</div>
            <form id="userForm">
                <div class="form-group">
                    <label for="userName">AdÄ±nÄ±z:</label>
                    <input type="text" id="userName" class="form-control" placeholder="AdÄ±nÄ±zÄ± girin" required>
                </div>
                <div class="form-group">
                    <label>Profil Rengi:</label>
                    <div class="color-picker">
                        <div class="color-option selected" style="background-color: #4CAF50;" data-color="#4CAF50">
                        </div>
                        <div class="color-option" style="background-color: #2196F3;" data-color="#2196F3"></div>
                        <div class="color-option" style="background-color: #f44336;" data-color="#f44336"></div>
                        <div class="color-option" style="background-color: #9c27b0;" data-color="#9c27b0"></div>
                        <div class="color-option" style="background-color: #ff9800;" data-color="#ff9800"></div>
                        <div class="color-option" style="background-color: #795548;" data-color="#795548"></div>
                    </div>
                </div>
                <button type="submit" class="btn-primary">GÃ¶rÃ¼ÅŸmeye BaÅŸla</button>
            </form>
        </div>
    </div>

    <h1>WebRTC SinyalleÅŸme Test UygulamasÄ±</h1>
    <div class="container">
        <div class="row">
            <input type="text" id="roomId" placeholder="Oda ID'si girin">
            <button id="createRoom">Oda OluÅŸtur</button>
            <button id="joinRoom">Odaya KatÄ±l</button>
            <button id="leaveRoom" disabled>Odadan AyrÄ±l</button>
        </div>

        <div class="video-container">
            <div>
                <h3>Yerel Video</h3>
                <video id="localVideo" autoplay muted playsinline></video>
                <div class="media-controls">
                    <button id="toggleMicBtn"><i class="fas fa-microphone"></i></button>
                    <button id="toggleCamBtn"><i class="fas fa-video"></i></button>
                    <button id="shareScreenBtn"><i class="fas fa-desktop"></i> EkranÄ± PaylaÅŸ</button>
                    <button id="fullscreenBtn"><i class="fas fa-expand"></i></button>
                </div>
            </div>
            <div id="remoteVideosContainer">
                <!-- Remote videos will be dynamically added here -->
            </div>
        </div>

        <!-- Chat BÃ¶lÃ¼mÃ¼ -->
        <div class="chat-container">
            <h3>Sohbet</h3>
            <div id="chatMessages" class="chat-messages"></div>
            <div class="chat-input-area">
                <input type="text" id="chatInput" placeholder="MesajÄ±nÄ±zÄ± yazÄ±n...">
                <button id="sendMessageBtn">GÃ¶nder</button>
            </div>
        </div>

        <div>
            <h3>Log</h3>
            <div id="logContainer"></div>
        </div>
    </div>

    <script src="/socket.io/socket.io.js"></script>
    <script>
        // HTTPS kontrolÃ¼nÃ¼ kaldÄ±rÄ±yoruz
        // if (window.location.protocol !== 'https:' && window.location.hostname !== 'localhost') {
        //     window.location.href = 'https://' + window.location.host + window.location.pathname;
        // }

        const socket = io();
        let localStream;
        let peerConnections = new Map(); // Map of socketId -> RTCPeerConnection
        let roomId;
        let isInitiator = false;

        // HTML Elementleri
        const roomIdInput = document.getElementById('roomId');
        const createRoomBtn = document.getElementById('createRoom');
        const joinRoomBtn = document.getElementById('joinRoom');
        const leaveRoomBtn = document.getElementById('leaveRoom');
        const localVideo = document.getElementById('localVideo');
        const remoteVideosContainer = document.getElementById('remoteVideosContainer');
        const logContainer = document.getElementById('logContainer');

        // Medya kontrolleri iÃ§in HTML elementleri
        const toggleMicBtn = document.getElementById('toggleMicBtn');
        const toggleCamBtn = document.getElementById('toggleCamBtn');
        const shareScreenBtn = document.getElementById('shareScreenBtn');
        const fullscreenBtn = document.getElementById('fullscreenBtn');

        // Chat iÃ§in HTML elementleri
        const chatInput = document.getElementById('chatInput');
        const sendMessageBtn = document.getElementById('sendMessageBtn');
        const chatMessages = document.getElementById('chatMessages');

        // Medya kontrolleri iÃ§in deÄŸiÅŸkenler
        let isAudioEnabled = true;
        let isVideoEnabled = true;
        let screenStream = null;
        let isScreenSharing = false;

        // Basit kullanÄ±cÄ± bilgisi
        const userData = {
            id: 'user_' + Math.random().toString(36).substr(2, 9),
            name: 'KullanÄ±cÄ±_' + Math.floor(Math.random() * 1000)
        };

        // WebRTC YapÄ±landÄ±rmasÄ±
        const peerConfig = {
            iceServers: [
                // Google STUN SunucularÄ±
                { urls: 'stun:stun.l.google.com:19302' },
                { urls: 'stun:stun1.l.google.com:19302' },
                { urls: 'stun:stun2.l.google.com:19302' },
                { urls: 'stun:stun3.l.google.com:19302' },
                { urls: 'stun:stun4.l.google.com:19302' },
                // Cloudflare STUN
                { urls: 'stun:stun.cloudflare.com:3478' },
                // Ãœcretsiz TURN SunucularÄ±
                {
                    urls: 'turn:openrelay.metered.ca:80',
                    username: 'openrelayproject',
                    credential: 'openrelayproject'
                },
                {
                    urls: 'turn:openrelay.metered.ca:443',
                    username: 'openrelayproject',
                    credential: 'openrelayproject'
                },
                {
                    urls: 'turn:openrelay.metered.ca:443?transport=tcp',
                    username: 'openrelayproject',
                    credential: 'openrelayproject'
                }
            ],
            iceCandidatePoolSize: 10 //10 olmasÄ± ÅŸu anlama geliyor: 10 adet ice candidate oluÅŸturulacak.
        };

        // Medya KÄ±sÄ±tlamalarÄ±
        const mediaConstraints = {
            video: {
                width: { ideal: 640 },
                height: { ideal: 480 },
                frameRate: { max: 15 }
            },
            audio: true
        };

        // Log fonksiyonu
        function log(message, type = 'info') {
            const entry = document.createElement('div');
            entry.classList.add('log-entry');
            if (type === 'error') entry.classList.add('error');
            if (type === 'success') entry.classList.add('success');

            const time = new Date().toLocaleTimeString();
            entry.textContent = `[${time}] ${message}`;

            logContainer.appendChild(entry);
            logContainer.scrollTop = logContainer.scrollHeight;

            console.log(`[${type}] ${message}`);
        }

        // Yerel Medya AkÄ±ÅŸÄ±nÄ± BaÅŸlat
        async function startLocalStream() {
            try {
                localStream = await navigator.mediaDevices.getUserMedia(mediaConstraints);
                localVideo.srcObject = localStream;
                log('Yerel video akÄ±ÅŸÄ± baÅŸlatÄ±ldÄ±', 'success');
                return true;
            } catch (error) {
                log(`Medya akÄ±ÅŸÄ± baÅŸlatÄ±lamadÄ±: ${error.message}`, 'error');
                return false;
            }
        }

        // Peer Connection OluÅŸtur
        function createPeerConnection(targetId) {
            try {
                const peerConnection = new RTCPeerConnection(peerConfig);
                log(`PeerConnection oluÅŸturuldu (hedef: ${targetId})`);

                // BaÄŸlantÄ± olaylarÄ±
                peerConnection.onicecandidate = (event) => handleIceCandidate(event, targetId);
                peerConnection.ontrack = (event) => handleRemoteStreamAdded(event, targetId);
                peerConnection.oniceconnectionstatechange = () => handleIceConnectionStateChange(targetId);

                // Ek hata ayÄ±klama olaylarÄ±
                peerConnection.onicegatheringstatechange = () => {
                    console.log(`ICE Toplama Durumu (${targetId}):`, peerConnection.iceGatheringState);
                    log(`ICE Toplama Durumu (${targetId}): ${peerConnection.iceGatheringState}`);
                };

                peerConnection.onsignalingstatechange = () => {
                    console.log(`SinyalleÅŸme Durumu (${targetId}):`, peerConnection.signalingState);
                    log(`SinyalleÅŸme Durumu (${targetId}): ${peerConnection.signalingState}`);
                };

                peerConnection.onconnectionstatechange = () => {
                    console.log(`BaÄŸlantÄ± Durumu (${targetId}):`, peerConnection.connectionState);
                    log(`BaÄŸlantÄ± Durumu (${targetId}): ${peerConnection.connectionState}`);

                    // BaÄŸlantÄ± kapatÄ±ldÄ±ysa temizle
                    if (peerConnection.connectionState === 'closed' ||
                        peerConnection.connectionState === 'failed' ||
                        peerConnection.connectionState === 'disconnected') {
                        removePeerConnection(targetId);
                    }
                };

                // Yerel akÄ±ÅŸÄ± ekle
                localStream.getTracks().forEach(track => {
                    peerConnection.addTrack(track, localStream);
                });

                // Peer baÄŸlantÄ±sÄ±nÄ± sakla
                peerConnections.set(targetId, peerConnection);

                return peerConnection;
            } catch (error) {
                log(`PeerConnection oluÅŸturulamadÄ± (${targetId}): ${error.message}`, 'error');
                return null;
            }
        }

        // Peer baÄŸlantÄ±sÄ±nÄ± kaldÄ±r
        function removePeerConnection(targetId) {
            const peerConnection = peerConnections.get(targetId);
            if (peerConnection) {
                try {
                    peerConnection.onicecandidate = null;
                    peerConnection.ontrack = null;
                    peerConnection.oniceconnectionstatechange = null;
                    peerConnection.close();

                    // Video elementini kaldÄ±r
                    removeRemoteVideo(targetId);

                    // Map'ten kaldÄ±r
                    peerConnections.delete(targetId);
                    log(`Peer baÄŸlantÄ±sÄ± kaldÄ±rÄ±ldÄ±: ${targetId}`);
                } catch (error) {
                    log(`Peer baÄŸlantÄ±sÄ±nÄ± kaldÄ±rÄ±rken hata: ${error.message}`, 'error');
                }
            }
        }

        // ICE AdayÄ± OlayÄ±
        function handleIceCandidate(event, targetId) {
            if (event.candidate) {
                console.log(`ICE adayÄ± oluÅŸturuldu (${targetId}):`, event.candidate);
                log(`ICE aday gÃ¶nderiliyor (${event.candidate.protocol || 'bilinmeyen'}) -> ${targetId}`);
                socket.emit('ice-candidate', {
                    targetId: targetId,
                    candidate: event.candidate
                });
            } else {
                console.log(`ICE aday toplama iÅŸlemi tamamlandÄ± (${targetId})`);
                log(`ICE aday toplama iÅŸlemi tamamlandÄ± (${targetId})`);
            }
        }

        // Uzak AkÄ±ÅŸ Eklendi OlayÄ±
        function handleRemoteStreamAdded(event, targetId) {
            log(`Uzak stream alÄ±ndÄ± (${targetId})`, 'success');

            // Uzak video elementini oluÅŸtur veya gÃ¼ncelle
            createOrUpdateRemoteVideo(targetId, event.streams[0]);
        }

        // Uzak video elementi oluÅŸtur veya gÃ¼ncelle
        function createOrUpdateRemoteVideo(targetId, stream) {
            const container = document.getElementById('remoteVideosContainer');
            let videoEl = document.getElementById(`remote-video-${targetId}`);

            // Video elementi yoksa oluÅŸtur
            if (!videoEl) {
                const videoContainer = document.createElement('div');
                videoContainer.className = 'remote-video-wrapper';
                videoContainer.id = `remote-container-${targetId}`;

                // KullanÄ±cÄ± adÄ±nÄ± gÃ¶steren baÅŸlÄ±k
                const nameEl = document.createElement('h3');
                nameEl.id = `remote-name-${targetId}`;
                nameEl.textContent = `Uzak Video (${targetId.substring(0, 5)}...)`;

                // Video elementi
                videoEl = document.createElement('video');
                videoEl.id = `remote-video-${targetId}`;
                videoEl.autoplay = true;
                videoEl.playsinline = true;

                // Kontrol butonu
                const fullscreenBtn = document.createElement('button');
                fullscreenBtn.innerHTML = '<i class="fas fa-expand"></i>';
                fullscreenBtn.onclick = () => toggleFullscreen(videoEl);

                const controls = document.createElement('div');
                controls.className = 'media-controls';
                controls.appendChild(fullscreenBtn);

                // TÃ¼mÃ¼nÃ¼ ekle
                videoContainer.appendChild(nameEl);
                videoContainer.appendChild(videoEl);
                videoContainer.appendChild(controls);
                container.appendChild(videoContainer);

                log(`Uzak video elementi oluÅŸturuldu: ${targetId}`);
            }

            // KullanÄ±cÄ± adÄ±nÄ± gÃ¼ncelle
            const peerUserData = getUserDataFromPeerId(targetId);
            if (peerUserData && peerUserData.name) {
                const nameEl = document.getElementById(`remote-name-${targetId}`);
                if (nameEl) {
                    nameEl.textContent = peerUserData.name || `Uzak Video (${targetId.substring(0, 5)}...)`;
                }
            }

            // Stream'i gÃ¼ncelle
            videoEl.srcObject = stream;
        }

        // Uzak video elementini kaldÄ±r
        function removeRemoteVideo(targetId) {
            const container = document.getElementById(`remote-container-${targetId}`);
            if (container) {
                container.remove();
                log(`Uzak video elementi kaldÄ±rÄ±ldÄ±: ${targetId}`);
            }
        }

        // KullanÄ±cÄ± bilgisini ID'den al
        function getUserDataFromPeerId(peerId) {
            // Bu fonksiyonu uygun ÅŸekilde implemente edin
            // Ã–rneÄŸin, aktif baÄŸlantÄ±lar iÃ§in bir kullanÄ±cÄ± listesi tutabilirsiniz
            return null; // Åžimdilik null dÃ¶nÃ¼yoruz
        }

        // ICE BaÄŸlantÄ± Durumu DeÄŸiÅŸikliÄŸi
        function handleIceConnectionStateChange(targetId) {
            const peerConnection = peerConnections.get(targetId);
            if (!peerConnection) return;

            console.log(`ICE BaÄŸlantÄ± Durumu (${targetId}):`, peerConnection.iceConnectionState);
            log(`ICE BaÄŸlantÄ± Durumu (${targetId}): ${peerConnection.iceConnectionState}`);

            switch (peerConnection.iceConnectionState) {
                case 'checking':
                    log(`ICE baÄŸlantÄ±larÄ± kontrol ediliyor (${targetId})...`, 'info');
                    break;
                case 'connected':
                    log(`ICE baÄŸlantÄ±sÄ± baÅŸarÄ±lÄ± (${targetId})!`, 'success');
                    break;
                case 'completed':
                    log(`ICE baÄŸlantÄ±sÄ± tamamlandÄ± (${targetId})`, 'success');
                    break;
                case 'disconnected':
                    log(`ICE baÄŸlantÄ±sÄ± kesildi (${targetId})`, 'error');
                    break;
                case 'failed':
                    log(`ICE baÄŸlantÄ±sÄ± baÅŸarÄ±sÄ±z oldu (${targetId})`, 'error');
                    // BaÄŸlantÄ±yÄ± yeniden deneyebilirsiniz
                    break;
                case 'closed':
                    log(`ICE baÄŸlantÄ±sÄ± kapatÄ±ldÄ± (${targetId})`, 'error');
                    removePeerConnection(targetId);
                    break;
            }
        }

        // Video AramasÄ±nÄ± Kapat
        function closeVideoCall() {
            // TÃ¼m peer baÄŸlantÄ±larÄ±nÄ± kapat
            for (const [targetId, peerConnection] of peerConnections.entries()) {
                removePeerConnection(targetId);
            }

            // Map'i temizle
            peerConnections.clear();

            // Remote video container'Ä±nÄ± temizle
            const container = document.getElementById('remoteVideosContainer');
            container.innerHTML = '';

            leaveRoomBtn.disabled = true;
            createRoomBtn.disabled = false;
            joinRoomBtn.disabled = false;

            log('TÃ¼m baÄŸlantÄ±lar kapatÄ±ldÄ±');
        }

        // Odadan AyrÄ±l
        function leaveRoom() {
            if (roomId) {
                socket.emit('leave', { roomId });
                log(`${roomId} odasÄ±ndan ayrÄ±ldÄ±nÄ±z`);
                roomId = null;
            }

            closeVideoCall();

            // KullanÄ±cÄ± verilerini temizle
            peersUserData.clear();
        }

        // Oda OluÅŸtur
        createRoomBtn.addEventListener('click', async () => {
            roomId = roomIdInput.value || Math.random().toString(36).substring(2, 7);
            roomIdInput.value = roomId;

            try {
                const response = await fetch(`/create-room?roomId=${roomId}`);
                const data = await response.json();
                log(`${data.message}: ${data.roomId}`);

                if (await startLocalStream()) {
                    socket.emit('join', {
                        roomId,
                        userData
                    });
                    isInitiator = true;
                    createRoomBtn.disabled = true;
                    joinRoomBtn.disabled = true;
                    leaveRoomBtn.disabled = false;
                }
            } catch (error) {
                log(`Oda oluÅŸturma hatasÄ±: ${error.message}`, 'error');
            }
        });

        // Odaya KatÄ±l
        joinRoomBtn.addEventListener('click', async () => {
            roomId = roomIdInput.value;

            if (!roomId) {
                log('LÃ¼tfen bir oda ID\'si girin', 'error');
                return;
            }

            try {
                const response = await fetch(`/find-room?roomId=${roomId}`);
                const data = await response.json();

                if (data.message === 'Room found') {
                    log(`${roomId} odasÄ±na katÄ±lÄ±nÄ±yor`);

                    if (await startLocalStream()) {
                        socket.emit('join', {
                            roomId,
                            userData
                        });
                        isInitiator = false;
                        createRoomBtn.disabled = true;
                        joinRoomBtn.disabled = true;
                        leaveRoomBtn.disabled = false;
                    }
                } else {
                    log(`Oda bulunamadÄ±: ${roomId}`, 'error');
                }
            } catch (error) {
                log(`Odaya katÄ±lma hatasÄ±: ${error.message}`, 'error');
            }
        });

        // Odadan AyrÄ±l
        leaveRoomBtn.addEventListener('click', () => {
            leaveRoom();
        });

        // Socket.io OlaylarÄ±
        let peersUserData = new Map(); // socketId -> userData

        socket.on('connect', () => {
            log(`Socket.io sunucusuna baÄŸlandÄ±: ${socket.id}`, 'success');
        });

        // Mevcut katÄ±lÄ±mcÄ±lar
        socket.on('existing-participants', (participants) => {
            log(`${participants.length} mevcut katÄ±lÄ±mcÄ± bilgisi alÄ±ndÄ±`);

            // Her bir katÄ±lÄ±mcÄ± iÃ§in peer baÄŸlantÄ±sÄ± oluÅŸtur
            participants.forEach(participant => {
                // KullanÄ±cÄ± verisini sakla
                if (participant.userData) {
                    peersUserData.set(participant.socketId, participant.userData);
                }

                // BaÄŸlantÄ± oluÅŸtur
                const peerConnection = createPeerConnection(participant.socketId);
                if (peerConnection) {
                    // Teklif oluÅŸtur
                    peerConnection.createOffer()
                        .then(offer => peerConnection.setLocalDescription(offer))
                        .then(() => {
                            const peerName = participant.userData ? participant.userData.name : participant.socketId;
                            log(`SDP teklifi gÃ¶nderiliyor -> ${peerName}`);
                            socket.emit('sdp', {
                                targetId: participant.socketId,
                                sdp: peerConnection.localDescription
                            });
                        })
                        .catch(error => log(`Teklif oluÅŸturma hatasÄ±: ${error.message}`, 'error'));
                }
            });
        });

        // Yeni peer
        socket.on('new-peer', ({ socketId, userData }) => {
            const peerName = userData ? userData.name : socketId;
            log(`Yeni kullanÄ±cÄ± katÄ±ldÄ±: ${peerName}`);

            // KullanÄ±cÄ± verisini sakla
            if (userData) {
                peersUserData.set(socketId, userData);
            }

            // Entegrasyon: GÃ¶rÃ¼ÅŸme baÅŸlama logunu harici API'ye gÃ¶nder
            logCallEvent('started', socketId, userData);

            // Bu istemci zaten baÄŸlÄ± ise tekrar baÄŸlantÄ± kurmayÄ± Ã¶nle
            if (peerConnections.has(socketId)) {
                log(`${socketId} ile zaten bir baÄŸlantÄ± var`);
                return;
            }

            // BaÄŸlantÄ± kurulmadÄ±ysa kur (sadece oda kurucusu ise)
            if (isInitiator) {
                const peerConnection = createPeerConnection(socketId);
                if (peerConnection) {
                    // Teklif oluÅŸtur
                    peerConnection.createOffer()
                        .then(offer => peerConnection.setLocalDescription(offer))
                        .then(() => {
                            log(`SDP teklifi gÃ¶nderiliyor -> ${peerName}`);
                            socket.emit('sdp', {
                                targetId: socketId,
                                sdp: peerConnection.localDescription
                            });
                        })
                        .catch(error => log(`Teklif oluÅŸturma hatasÄ±: ${error.message}`, 'error'));
                }
            }
        });

        socket.on('sdp', ({ senderId, sdp }) => {
            const peerUserData = peersUserData.get(senderId);
            const peerName = peerUserData ? peerUserData.name : senderId;
            log(`SDP alÄ±ndÄ±: ${sdp.type} <- ${peerName}`);

            let peerConnection = peerConnections.get(senderId);
            if (!peerConnection) {
                peerConnection = createPeerConnection(senderId);
            }

            if (!peerConnection) {
                log(`${senderId} iÃ§in peer baÄŸlantÄ±sÄ± oluÅŸturulamadÄ±`, 'error');
                return;
            }

            const rtcSdp = new RTCSessionDescription(sdp);

            peerConnection.setRemoteDescription(rtcSdp)
                .then(() => {
                    if (sdp.type === 'offer') {
                        log(`SDP cevabÄ± oluÅŸturuluyor -> ${peerName}`);
                        return peerConnection.createAnswer();
                    }
                })
                .then(answer => {
                    if (answer) {
                        return peerConnection.setLocalDescription(answer);
                    }
                })
                .then(() => {
                    if (sdp.type === 'offer') {
                        log(`SDP cevabÄ± gÃ¶nderiliyor -> ${peerName}`);
                        socket.emit('sdp', {
                            targetId: senderId,
                            sdp: peerConnection.localDescription
                        });
                    }
                })
                .catch(error => log(`SDP iÅŸleme hatasÄ±: ${error.message}`, 'error'));
        });

        socket.on('ice-candidate', ({ senderId, candidate }) => {
            const peerUserData = peersUserData.get(senderId);
            const peerName = peerUserData ? peerUserData.name : senderId;
            log(`ICE adayÄ± alÄ±ndÄ± <- ${peerName}`);

            const peerConnection = peerConnections.get(senderId);
            if (peerConnection) {
                peerConnection.addIceCandidate(new RTCIceCandidate(candidate))
                    .then(() => {
                        log(`ICE adayÄ± baÅŸarÄ±yla eklendi (${peerName})`);
                    })
                    .catch(error => log(`ICE aday ekleme hatasÄ±: ${error.message}`, 'error'));
            }
        });

        socket.on('disconnect', () => {
            log('Socket.io sunucusu ile baÄŸlantÄ± kesildi', 'error');
            closeVideoCall();
        });

        socket.on('peer-left', ({ socketId }) => {
            const peerUserData = peersUserData.get(socketId);
            const peerName = peerUserData ? peerUserData.name : socketId;
            log(`KatÄ±lÄ±mcÄ± ayrÄ±ldÄ±: ${peerName}`, 'error');

            // Entegrasyon: GÃ¶rÃ¼ÅŸme bitme logunu harici API'ye gÃ¶nder
            logCallEvent('ended', socketId, peerUserData);

            // Peer baÄŸlantÄ±sÄ±nÄ± kaldÄ±r
            removePeerConnection(socketId);

            // KullanÄ±cÄ± verisini sil
            peersUserData.delete(socketId);
        });

        // KullanÄ±cÄ± bilgisini dÃ¶ndÃ¼ren fonksiyon
        function getUserDataFromPeerId(peerId) {
            return peersUserData.get(peerId);
        }

        // ------ CHAT Ä°ÅžLEVSELLÄ°ÄžÄ° ------

        // Mesaj gÃ¶nderme fonksiyonu
        function sendChatMessage() {
            if (!roomId) {
                log('Mesaj gÃ¶ndermek iÃ§in bir odaya katÄ±lmalÄ±sÄ±nÄ±z', 'error');
                return;
            }

            const messageText = chatInput.value.trim();
            if (messageText === '') return;

            // MesajÄ± socket.io ile gÃ¶nder
            socket.emit('chat-message', {
                roomId,
                message: messageText,
                userData
            });

            // Entegrasyon: MesajÄ± harici API'ye gÃ¶nder
            logChatMessage(messageText);

            // Input alanÄ±nÄ± temizle
            chatInput.value = '';

            // Inputa odaklan
            chatInput.focus();
        }

        // Mesaj alma olayÄ±nÄ± dinle
        socket.on('chat-message', (messageData) => {
            displayChatMessage(messageData);
        });

        // Mesaj geÃ§miÅŸini alma
        socket.on('chat-history', (messages) => {
            // Mevcut mesajlarÄ± temizle
            chatMessages.innerHTML = '';

            // GeÃ§miÅŸ mesajlarÄ± gÃ¶rÃ¼ntÃ¼le
            messages.forEach(msg => {
                displayChatMessage(msg);
            });

            log(`${messages.length} mesajlÄ±k sohbet geÃ§miÅŸi alÄ±ndÄ±`, 'info');
        });

        // MesajÄ± ekranda gÃ¶sterme fonksiyonu
        function displayChatMessage(messageData) {
            // Mesaj elemanÄ±nÄ± oluÅŸtur
            const messageEl = document.createElement('div');
            messageEl.className = 'chat-message';

            // MesajÄ± gÃ¶nderen ben miyim?
            const isOwnMessage = messageData.sender.id === userData.id;
            messageEl.classList.add(isOwnMessage ? 'own' : 'other');

            // Zaman formatÄ±
            const date = new Date(messageData.timestamp);
            const timeStr = date.toLocaleTimeString([], { hour: '2-digit', minute: '2-digit' });

            // Mesaj iÃ§eriÄŸi
            const senderName = messageData.sender.name || 'Misafir';
            messageEl.innerHTML = `
                <div class="message-sender">${isOwnMessage ? 'Ben' : senderName}</div>
                <div class="message-content">${messageData.text}</div>
                <div class="message-time">${timeStr}</div>
            `;

            // MesajÄ± sohbet alanÄ±na ekle
            chatMessages.appendChild(messageEl);

            // Sohbet alanÄ±nÄ± aÅŸaÄŸÄ± kaydÄ±r
            chatMessages.scrollTop = chatMessages.scrollHeight;
        }

        // GÃ¶nder butonuna tÄ±klama olayÄ±
        sendMessageBtn.addEventListener('click', sendChatMessage);

        // Enter tuÅŸu ile mesaj gÃ¶nderme
        chatInput.addEventListener('keypress', (event) => {
            if (event.key === 'Enter') {
                sendChatMessage();
            }
        });

        // ------ HARICI SÄ°STEM ENTEGRASYONU ------

        // Mesaj log'unu harici sisteme gÃ¶nder
        async function logChatMessage(messageText) {
            try {
                // Harici API'ye istek at (mock data iÃ§in yorum satÄ±rÄ± olarak tutuyoruz)
                /*
                const response = await fetch('/api/external-logs/chat', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        roomId,
                        senderId: userData.id, 
                        message: messageText,
                        timestamp: new Date().toISOString()
                    })
                });
                
                const result = await response.json();
                console.log('Mesaj log sonucu:', result);
                */

                // Mock log
                console.log('ðŸ“ API Log (Chat):', {
                    roomId,
                    senderId: userData.id,
                    senderName: userData.name,
                    message: messageText,
                    timestamp: new Date().toISOString()
                });
            } catch (error) {
                console.error('Mesaj log hatasÄ±:', error);
            }
        }

        // GÃ¶rÃ¼ÅŸme log'unu harici sisteme gÃ¶nder
        async function logCallEvent(status, targetId, targetUserData) {
            try {
                const callData = {
                    roomId,
                    callerId: userData.id,
                    callerName: userData.name,
                    receiverId: targetId,
                    receiverName: targetUserData ? targetUserData.name : 'Unknown',
                    status,
                    timestamp: new Date().toISOString()
                };

                // Harici API'ye istek at (mock data iÃ§in yorum satÄ±rÄ± olarak tutuyoruz)
                /*
                const response = await fetch('/api/external-logs/call', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify(callData)
                });
                
                const result = await response.json();
                console.log('GÃ¶rÃ¼ÅŸme log sonucu:', result);
                */

                // Mock log
                console.log(`ðŸ“ž API Log (Call ${status}):`, callData);
            } catch (error) {
                console.error('GÃ¶rÃ¼ÅŸme log hatasÄ±:', error);
            }
        }

        // ------ KULLANICI GÄ°RÄ°Åž MODALI ------

        // DOM elementleri
        const userLoginModal = document.getElementById('userLoginModal');
        const userForm = document.getElementById('userForm');
        const userNameInput = document.getElementById('userName');
        const colorOptions = document.querySelectorAll('.color-option');

        // SeÃ§ili renk
        let selectedColor = '#4CAF50';

        // Renk seÃ§imi olaylarÄ±
        colorOptions.forEach(option => {
            option.addEventListener('click', () => {
                // Ã–nceki seÃ§imi kaldÄ±r
                document.querySelector('.color-option.selected').classList.remove('selected');
                // Yeni seÃ§imi iÅŸaretle
                option.classList.add('selected');
                // Rengi sakla
                selectedColor = option.getAttribute('data-color');
            });
        });

        // Form gÃ¶nderme
        userForm.addEventListener('submit', (event) => {
            event.preventDefault();

            const userName = userNameInput.value.trim();
            if (!userName) {
                alert('LÃ¼tfen adÄ±nÄ±zÄ± girin');
                return;
            }

            // KullanÄ±cÄ± verilerini gÃ¼ncelle
            userData.name = userName;
            userData.color = selectedColor;
            userData.initials = userName.substring(0, 2).toUpperCase();

            // ModalÄ± gizle
            userLoginModal.classList.add('hidden');

            // Ana uygulamayÄ± gÃ¶ster
            log(`HoÅŸ geldiniz, ${userName}!`, 'success');
        });

        // Sayfa yÃ¼klenmeden Ã¶nce uygulama container'Ä±nÄ± gizle
        document.addEventListener('DOMContentLoaded', () => {
            // Form gÃ¶nderildikten sonra ana uygulama gÃ¶sterilecek
        });

        // ------ MEDYA KONTROLLERÄ° ------

        // Mikrofon aÃ§ma/kapama
        function toggleMicrophone() {
            if (localStream) {
                const audioTracks = localStream.getAudioTracks();
                if (audioTracks.length === 0) return;

                const enabled = !audioTracks[0].enabled;
                audioTracks[0].enabled = enabled;
                isAudioEnabled = enabled;

                toggleMicBtn.innerHTML = enabled ?
                    '<i class="fas fa-microphone"></i>' :
                    '<i class="fas fa-microphone-slash"></i>';

                log(enabled ? 'Mikrofon aÃ§Ä±ldÄ±' : 'Mikrofon kapatÄ±ldÄ±', 'info');
            }
        }

        // Kamera aÃ§ma/kapama
        function toggleCamera() {
            if (localStream) {
                const videoTracks = localStream.getVideoTracks();
                if (videoTracks.length === 0) return;

                const enabled = !videoTracks[0].enabled;
                videoTracks[0].enabled = enabled;
                isVideoEnabled = enabled;

                toggleCamBtn.innerHTML = enabled ?
                    '<i class="fas fa-video"></i>' :
                    '<i class="fas fa-video-slash"></i>';

                log(enabled ? 'Kamera aÃ§Ä±ldÄ±' : 'Kamera kapatÄ±ldÄ±', 'info');
            }
        }

        // Ekran paylaÅŸÄ±mÄ± baÅŸlat/durdur
        async function toggleScreenSharing() {
            if (isScreenSharing) {
                // Ekran paylaÅŸÄ±mÄ±nÄ± durdur
                screenStream.getTracks().forEach(track => track.stop());
                screenStream = null;
                isScreenSharing = false;
                shareScreenBtn.innerHTML = '<i class="fas fa-desktop"></i> EkranÄ± PaylaÅŸ';

                // Tekrar kamera gÃ¶rÃ¼ntÃ¼sÃ¼ne dÃ¶n
                localVideo.srcObject = localStream;

                // WebRTC baÄŸlantÄ±sÄ±nÄ± gÃ¼ncelle
                updateMediaSenders(localStream);
                log('Ekran paylaÅŸÄ±mÄ± durduruldu', 'info');
            } else {
                try {
                    // Ekran paylaÅŸÄ±mÄ± baÅŸlat
                    screenStream = await navigator.mediaDevices.getDisplayMedia({
                        video: {
                            cursor: "always"
                        }
                    });

                    isScreenSharing = true;
                    shareScreenBtn.innerHTML = '<i class="fas fa-desktop"></i> PaylaÅŸÄ±mÄ± Durdur';

                    // Ekran gÃ¶rÃ¼ntÃ¼sÃ¼nÃ¼ gÃ¶ster
                    localVideo.srcObject = screenStream;

                    // WebRTC baÄŸlantÄ±sÄ±nÄ± gÃ¼ncelle
                    updateMediaSenders(screenStream);

                    // Ekran paylaÅŸÄ±mÄ± sonlandÄ±ÄŸÄ±nda otomatik olarak kapat
                    screenStream.getVideoTracks()[0].addEventListener('ended', () => {
                        toggleScreenSharing();
                    });

                    log('Ekran paylaÅŸÄ±mÄ± baÅŸlatÄ±ldÄ±', 'success');
                } catch (error) {
                    log(`Ekran paylaÅŸÄ±mÄ± baÅŸlatÄ±lamadÄ±: ${error.message}`, 'error');
                }
            }
        }

        // WebRTC Ã¼zerindeki medya alÄ±cÄ±larÄ±nÄ± gÃ¼ncelle
        function updateMediaSenders(stream) {
            if (peerConnections.size === 0) return;

            // Her bir peer baÄŸlantÄ±sÄ± iÃ§in medya akÄ±ÅŸlarÄ±nÄ± gÃ¼ncelle
            for (const [targetId, peerConnection] of peerConnections.entries()) {
                // Mevcut gÃ¶nderilenleri bul
                const senders = peerConnection.getSenders();

                // Video track'i gÃ¼ncelle
                const videoTrack = stream.getVideoTracks()[0];
                const videoSender = senders.find(sender => sender.track && sender.track.kind === 'video');

                if (videoSender && videoTrack) {
                    videoSender.replaceTrack(videoTrack)
                        .then(() => log(`Video track gÃ¼ncellendi (${targetId})`))
                        .catch(error => log(`Video track gÃ¼ncelleme hatasÄ± (${targetId}): ${error.message}`, 'error'));
                }
            }
        }

        // Tam ekran modu
        function toggleFullscreen(videoElement) {
            if (!document.fullscreenElement) {
                if (videoElement.requestFullscreen) {
                    videoElement.requestFullscreen();
                } else if (videoElement.webkitRequestFullscreen) { /* Safari */
                    videoElement.webkitRequestFullscreen();
                } else if (videoElement.msRequestFullscreen) { /* IE11 */
                    videoElement.msRequestFullscreen();
                }
            } else {
                if (document.exitFullscreen) {
                    document.exitFullscreen();
                } else if (document.webkitExitFullscreen) { /* Safari */
                    document.webkitExitFullscreen();
                } else if (document.msExitFullscreen) { /* IE11 */
                    document.msExitFullscreen();
                }
            }
        }

        // Medya kontrol butonlarÄ±na olay dinleyicileri ekle
        toggleMicBtn.addEventListener('click', toggleMicrophone);
        toggleCamBtn.addEventListener('click', toggleCamera);
        shareScreenBtn.addEventListener('click', toggleScreenSharing);
        fullscreenBtn.addEventListener('click', () => toggleFullscreen(localVideo));

        window.addEventListener('beforeunload', () => {
            leaveRoom();
        });
    </script>
</body>

</html>